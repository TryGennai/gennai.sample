SET default.parallelism=32
;
FROM (
  RequestPacket JOIN ResponsePacket
  ON RequestPacket.request_pheader.Destination_Port = ResponsePacket.response_pheader.Source_Port
  AND RequestPacket.request_pheader.Source_Port = ResponsePacket.response_pheader.Destination_Port
  AND RequestPacket.request_pheader.Destination_Ip = ResponsePacket.response_pheader.Source_Ip
  AND RequestPacket.request_pheader.Source_Ip = ResponsePacket.response_pheader.Destination_Ip
  TO
    RequestPacket.request_properties AS request_properties,
    RequestPacket._time AS request_time,
    ResponsePacket.response_properties AS response_properties,
    ResponsePacket._time AS response_time
) AS packet USING kafka_spout() parallelism 8
EACH
  request_properties.Host AS host,
  request_properties.Request_URI AS uri,
  response_properties.Status AS status,
  request_time,
  response_time
INTO s1
;
FROM s1
EACH *, ifnull(record, 'cnt_all') AS record, count() AS cnt
LIMIT FIRST EVERY 1min
EMIT record, cnt, request_time, response_time USING mongo_persist('front', 'output', ['record'])
;
FROM s1
EACH *, ifnull(record, 'cnt_all_time') AS record
SLIDE LENGTH 5min BY response_time count() AS cnt, record, request_time, response_time
LIMIT FIRST EVERY 1min
EMIT record, cnt, request_time, response_time USING mongo_persist('front', 'output', ['record'])
;
FROM s1
JOIN service ON service.host = host TO service.sid AS sid EXPIRE 10min USING mongo_fetch('front', 'service')
INTO s2
;
FROM s2
FILTER sid IS NULL
JOIN unknowns ON unknowns.host = host TO unknowns.host AS flag EXPIRE 10min USING mongo_fetch('front', 'unknowns')
FILTER flag IS NULL
EMIT host USING mongo_persist('front', 'unknowns')
;
FROM s2
EACH ifnull(sid, 'unknowns') AS sid, host, uri, status, request_time, response_time
BEGIN GROUP BY sid
INTO s3
;
FROM s3
EACH *, ifnull(record, 'cnt_sid') AS record, count() AS cnt
LIMIT FIRST EVERY 1min
EMIT record, cnt, sid, request_time, response_time USING mongo_persist('front', 'output', ['record', 'sid'])
;
FROM s3
EACH *, ifnull(record, 'cnt_sid_time') AS record
SLIDE LENGTH 5min BY response_time count() AS cnt, record, sid, request_time, response_time
LIMIT FIRST EVERY 1min
EMIT record, cnt, sid, request_time, response_time USING mongo_persist('front', 'output', ['record', 'sid'])
;
FROM s3
FILTER sid <> 'unknowns'
BEGIN GROUP BY host
INTO s4
;
FROM s4
EACH *, ifnull(record, 'cnt_host') AS record, count() AS cnt
LIMIT FIRST EVERY 1min
EMIT record, cnt, sid, host, request_time, response_time USING mongo_persist('front', 'output', ['record', 'sid', 'host'])
;
FROM s4
EACH *, ifnull(record, 'cnt_host_time') AS record
SLIDE LENGTH 5min BY response_time count() AS cnt, record, sid, host, request_time, response_time
LIMIT FIRST EVERY 1min
EMIT record, cnt, sid, host, request_time, response_time USING mongo_persist('front', 'output', ['record', 'sid', 'host'])
;
FROM s4
FILTER NOT status IN ('HTTP/1.0 200 OK', 'HTTP/1.1 200 OK', 'HTTP/1.1 206 Partial Content', 'HTTP/1.1 301 Moved Permanently', 'HTTP/1.1 302 Found', 'HTTP/1.1 304 Not Modified')
BEGIN GROUP BY status
INTO s5
;
FROM s5
EACH *, ifnull(record, 'cnt_status') AS record, count() AS cnt
LIMIT FIRST EVERY 1min
EMIT record, cnt, sid, host, status, request_time, response_time USING mongo_persist('front', 'output', ['record', 'sid', 'host', 'status'])
;
FROM s5
EACH *, ifnull(record, 'cnt_status_time') AS record
SLIDE LENGTH 5min BY response_time count() AS cnt, record, sid, host, uri, status, request_time, response_time
LIMIT FIRST EVERY 1min
EMIT record, cnt, sid, host, status, request_time, response_time USING mongo_persist('front', 'output', ['record', 'sid', 'host', 'status'])
;
FROM s5
EACH *, ifnull(record, 'uri_status') AS record
EMIT record, sid, host, uri, status, request_time, response_time USING mongo_persist('front', 'output')
;
